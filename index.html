<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ram Earning Tools - Earn Money Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        * {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #f9fafb;
            overflow-x: hidden;
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 100%;
        }
        
        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .gradient-btn:active {
            transform: translateY(0);
        }
        
        .gradient-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            padding: 16px;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            white-space: nowrap;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        
        /* Mobile Optimizations */
        .mobile-stack {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .mobile-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .method-btn {
            padding: 12px 8px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .method-btn.active {
            border-color: #8b5cf6;
            background: #f5f3ff;
            color: #8b5cf6;
        }

        .user-logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
            font-size: 14px;
            border: none;
        }

        .user-logout-btn:active {
            transform: scale(0.95);
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: block;
            padding: 8px;
            background: transparent;
            border: none;
            font-size: 24px;
            color: #6b7280;
        }
        
        .mobile-nav {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            z-index: 1000;
            transition: left 0.3s ease;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .mobile-nav.open {
            left: 0;
        }
        
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .mobile-nav-overlay.open {
            display: block;
        }
        
        /* Touch-friendly buttons */
        button, 
        [role="button"],
        .clickable {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        /* Payout Card Animation */
        .payout-card {
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Stats Card */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }
        
        /* Better spacing on mobile */
        @media (max-width: 640px) {
            .container {
                padding-left: 12px;
                padding-right: 12px;
            }
            
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            .gap-4 {
                gap: 0.75rem !important;
            }
            
            .stat-card {
                padding: 16px !important;
            }
            
            .grid {
                gap: 12px !important;
            }
            
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>

    <!-- Mobile Navigation -->
    <div id="mobileNavOverlay" class="mobile-nav-overlay" onclick="closeMobileNav()"></div>
    <div id="mobileNav" class="mobile-nav">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">Menu</h2>
            <button onclick="closeMobileNav()" class="text-gray-500 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="showSection('home'); closeMobileNav()" class="text-left p-3 hover:bg-gray-100 rounded-lg">Home</button>
            <button onclick="showSection('dashboard'); closeMobileNav()" class="text-left p-3 hover:bg-gray-100 rounded-lg">Dashboard</button>
            <button id="mobileAdminBtn" onclick="showSection('admin'); closeMobileNav()" class="text-left p-3 hover:bg-gray-100 rounded-lg">Admin</button>
            <button id="mobileLogoutBtn" onclick="logout(); closeMobileNav()" class="hidden text-left p-3 text-red-600 hover:bg-red-50 rounded-lg">Logout</button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-lg md:text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    Ram Earning Tools
                </h1>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-4">
                    <button onclick="showSection('home')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">Home</button>
                    <button onclick="showSection('dashboard')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">Dashboard</button>
                    <button id="desktopAdminBtn" onclick="showSection('admin')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">
                        <i class="fas fa-user-shield text-xl"></i>
                    </button>
                    <button id="desktopLogoutBtn" onclick="logout()" class="hidden text-red-600 hover:text-red-700 px-3 py-2">
                        <i class="fas fa-sign-out-alt text-xl"></i> Logout
                    </button>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn md:hidden" onclick="openMobileNav()">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- User Logout Button (for dashboard) -->
    <button id="userLogoutBtn" class="user-logout-btn hidden" onclick="userLogout()">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout
    </button>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-4 md:py-8">
        
        <!-- Home Section -->
        <div id="homeSection">
            <!-- Hero -->
            <div class="text-center py-8 md:py-12">
                <h1 class="text-2xl md:text-4xl font-bold text-gray-900 mb-3">Start Earning Money Today!</h1>
                <p class="text-sm md:text-lg text-gray-600 mb-6 max-w-2xl mx-auto px-4">Join thousands of users who are already earning daily with Ram Earning Tools.</p>
                <button onclick="showRegisterModal()" class="gradient-btn text-white px-6 md:px-8 py-3 rounded-lg text-base md:text-lg font-semibold w-auto">
                    <i class="fas fa-rocket mr-2"></i>Start Earning Now
                </button>
            </div>

            <!-- Registration Modal -->
            <div id="registerModal" class="hidden fixed inset-0 modal z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full p-6 modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Register</h2>
                        <button onclick="hideRegisterModal()" class="text-gray-500 hover:text-gray-700 p-2">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Your Name</label>
                        <input type="text" id="regName" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter your name">
                    </div>
                    <button onclick="registerUser()" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                        <i class="fas fa-user-plus mr-2"></i>Register
                    </button>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="hidden fixed inset-0 modal z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full p-6 modal-content">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check-circle text-3xl text-green-500"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2">Registration Successful!</h2>
                        <p class="text-sm text-gray-600 mb-4">Your account is pending approval</p>
                        <div class="bg-purple-50 p-4 rounded-lg mb-4">
                            <p class="text-xs text-purple-600 mb-1">Your User ID:</p>
                            <p id="successUserId" class="text-base font-mono font-bold break-all"></p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-xs text-gray-600 mb-1">Referral Link:</p>
                            <p id="successLink" class="text-xs text-blue-600 break-all mb-2"></p>
                            <button onclick="copySuccessLink()" class="text-purple-600 hover:text-purple-700 p-2">
                                <i class="fas fa-copy mr-1"></i>Copy Link
                            </button>
                        </div>
                        <button onclick="goHome()" class="gradient-btn text-white px-6 py-2 rounded-lg w-full">
                            Continue to Home
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Payouts Section -->
            <div class="my-8">
                <h2 class="text-xl font-bold text-center mb-6">ðŸ’° Recent Payouts</h2>
                <div id="recentPayoutsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-center text-gray-500 col-span-3">Loading payouts...</p>
                </div>
            </div>

            <!-- Features -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8">
                <div class="card p-6 text-center">
                    <i class="fas fa-bolt text-2xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">Daily Earnings</h3>
                    <p class="text-sm text-gray-600">Get paid every day for your views</p>
                </div>
                <div class="card p-6 text-center">
                    <i class="fas fa-shield-alt text-2xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">100% Secure</h3>
                    <p class="text-sm text-gray-600">Your payments are protected</p>
                </div>
                <div class="card p-6 text-center">
                    <i class="fas fa-headset text-2xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">24/7 Support</h3>
                    <p class="text-sm text-gray-600">We're always here to help</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="max-w-4xl mx-auto">
                <!-- User ID Input -->
                <div id="userIdInput" class="card p-6 mb-4">
                    <h2 class="text-lg font-bold mb-4">Enter Your User ID</h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="userId" class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., RETABC123">
                        <button onclick="loadDashboard()" class="gradient-btn text-white px-6 py-3 rounded-lg w-full sm:w-auto">
                            View Dashboard
                        </button>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden space-y-4">
                    <!-- User Info -->
                    <div class="card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                            <h2 class="text-xl font-bold" id="dashName"></h2>
                            <span id="dashStatus" class="status-badge"></span>
                        </div>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                <p class="text-sm opacity-90">Total Views</p>
                                <p class="text-2xl font-bold" id="totalViews">0</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg">
                                <p class="text-sm opacity-90">Total Earnings</p>
                                <p class="text-2xl font-bold" id="totalEarnings">â‚¹0</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                                <p class="text-sm opacity-90">Available Balance</p>
                                <p class="text-2xl font-bold" id="availableBalance">â‚¹0</p>
                            </div>
                        </div>

                        <!-- User Details -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-500">User ID</p>
                                <p id="dashUserId" class="text-sm font-mono font-semibold break-all"></p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-500">Referral Link</p>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <p id="dashReferral" class="text-xs text-blue-600 break-all flex-1"></p>
                                    <button onclick="copyDashLink()" class="copy-btn p-2">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monetag Link Section -->
                        <div id="monetagContainer" class="hidden bg-purple-50 p-4 rounded-lg mb-4">
                            <p class="text-xs text-purple-600 mb-2">Your Earning Link:</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <a id="monetagLink" href="#" target="_blank" class="text-sm text-blue-600 hover:underline break-all flex-1"></a>
                                <button onclick="copyMonetagLink()" class="copy-btn p-2">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Earnings Table -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-4">ðŸ“Š Daily Earnings</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Views</th>
                                        <th>Earnings</th>
                                    </tr>
                                </thead>
                                <tbody id="earningsTableBody">
                                    <tr>
                                        <td colspan="3" class="text-center py-4 text-gray-500">Loading earnings...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Withdrawal -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-4">ðŸ’° Request Withdrawal</h3>
                        <div class="bg-purple-50 p-4 rounded mb-4">
                            <p class="text-xs text-purple-600">Available Balance</p>
                            <p class="text-2xl font-bold text-purple-700" id="balance">â‚¹0</p>
                            <p class="text-xs text-purple-500 mt-1" id="minAmount">Min: â‚¹50</p>
                        </div>
                        <div class="space-y-4">
                            <input type="number" id="withdrawAmount" class="w-full px-4 py-3 border rounded-lg" placeholder="Enter Amount">
                            
                            <!-- Payment Methods -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Select Payment Method</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="setMethod('gpay')" id="methodGpay" class="method-btn text-sm">
                                        <i class="fab fa-google-pay"></i>
                                        <span class="hidden sm:inline">Google Pay</span>
                                    </button>
                                    <button onclick="setMethod('phonepe')" id="methodPhonepe" class="method-btn text-sm">
                                        <i class="fas fa-mobile-alt"></i>
                                        <span class="hidden sm:inline">PhonePe</span>
                                    </button>
                                    <button onclick="setMethod('upi')" id="methodUpi" class="method-btn text-sm active">
                                        <i class="fas fa-university"></i>
                                        <span class="hidden sm:inline">UPI</span>
                                    </button>
                                </div>
                            </div>

                            <!-- UPI ID Input -->
                            <div>
                                <label class="block text-sm font-medium mb-2">UPI ID</label>
                                <input type="text" id="upiId" class="w-full px-4 py-3 border rounded-lg" placeholder="e.g., name@okhdfcbank">
                                <p class="text-xs text-gray-500 mt-1">Example: username@okhdfcbank, username@ybl</p>
                            </div>

                            <button onclick="submitWithdrawal()" id="withdrawBtn" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                                <i class="fas fa-money-bill-wave mr-2"></i>Request Withdrawal
                            </button>
                        </div>
                    </div>

                    <!-- Withdrawal History -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-4">ðŸ“œ Withdrawal History</h3>
                        <div id="historyList" class="space-y-3">
                            <p class="text-center text-gray-500 py-4">No history yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="hidden">
            <div class="max-w-7xl mx-auto">
                <!-- Login Form -->
                <div id="adminLogin" class="card p-6 max-w-md mx-auto">
                    <h2 class="text-xl font-bold mb-4 text-center">Admin Login</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="adminEmail" class="w-full px-4 py-3 border rounded-lg" placeholder="Enter your email">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-lg" placeholder="Enter your password">
                        </div>
                        <button onclick="adminLogin()" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                    </div>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="stat-card">
                            <p class="text-xl font-bold" id="adminTotalUsers">0</p>
                            <p class="text-xs">Total Users</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">
                            <p class="text-xl font-bold" id="adminPendingUsers">0</p>
                            <p class="text-xs">Pending</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">
                            <p class="text-xl font-bold" id="adminApprovedUsers">0</p>
                            <p class="text-xs">Approved</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)">
                            <p class="text-xl font-bold" id="adminTotalWithdrawals">0</p>
                            <p class="text-xs">Withdrawals</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%)">
                            <p class="text-xl font-bold" id="adminPendingWithdrawals">0</p>
                            <p class="text-xs">Pending WD</p>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex flex-wrap gap-2 mb-4 border-b">
                        <button onclick="switchTab('users')" class="tab-btn px-4 py-2 text-sm active" id="usersTabBtn">
                            <i class="fas fa-users mr-1"></i>All Users
                        </button>
                        <button onclick="switchTab('pending')" class="tab-btn px-4 py-2 text-sm" id="pendingTabBtn">
                            <i class="fas fa-clock mr-1"></i>Pending
                        </button>
                        <button onclick="switchTab('approved')" class="tab-btn px-4 py-2 text-sm" id="approvedTabBtn">
                            <i class="fas fa-check-circle mr-1"></i>Approved
                        </button>
                        <button onclick="switchTab('withdrawals')" class="tab-btn px-4 py-2 text-sm" id="withdrawalsTabBtn">
                            <i class="fas fa-money-bill-wave mr-1"></i>Withdrawals
                        </button>
                        <button onclick="switchTab('earnings')" class="tab-btn px-4 py-2 text-sm" id="earningsTabBtn">
                            <i class="fas fa-chart-line mr-1"></i>Add Earnings
                        </button>
                    </div>

                    <!-- All Users Tab -->
                    <div id="usersTab" class="card p-4">
                        <h3 class="text-lg font-bold mb-4">All Users</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>User ID</th>
                                        <th>Status</th>
                                        <th>Total Views</th>
                                        <th>Total Earnings</th>
                                        <th>Withdrawn</th>
                                        <th>Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allUsersList">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pending Users Tab -->
                    <div id="pendingTab" class="hidden card p-4">
                        <h3 class="text-lg font-bold mb-4">Pending Approval</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>User ID</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingUsersList">
                                    <tr>
                                        <td colspan="4" class="text-center py-4">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Approved Users Tab -->
                    <div id="approvedTab" class="hidden card p-4">
                        <h3 class="text-lg font-bold mb-4">Approved Users</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>User ID</th>
                                        <th>Views</th>
                                        <th>Earnings</th>
                                        <th>Monetag Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedUsersList">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Withdrawals Tab -->
                    <div id="withdrawalsTab" class="hidden card p-4">
                        <h3 class="text-lg font-bold mb-4">Withdrawal Requests</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>UPI</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawalsList">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add Earnings Tab -->
                    <div id="earningsTab" class="hidden card p-4">
                        <h3 class="text-lg font-bold mb-4">âž• Add Daily Earnings</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- User Selection -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Select User</label>
                                <select id="earningsUserSelect" class="w-full px-4 py-3 border rounded-lg">
                                    <option value="">Loading users...</option>
                                </select>
                            </div>
                            
                            <!-- Earnings Form -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Date</label>
                                    <input type="date" id="earningsDate" class="w-full px-4 py-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Views</label>
                                    <input type="number" id="earningsViews" class="w-full px-4 py-3 border rounded-lg" placeholder="Enter views count">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Earnings (â‚¹)</label>
                                    <input type="number" id="earningsAmount" class="w-full px-4 py-3 border rounded-lg" placeholder="Enter earnings amount">
                                </div>
                                <button onclick="addDailyEarnings()" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                                    <i class="fas fa-plus-circle mr-2"></i>Add Earnings
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Earnings for Selected User -->
                        <div class="mt-6">
                            <h4 class="font-bold mb-3">Recent Earnings for Selected User</h4>
                            <div id="selectedUserEarnings" class="space-y-2">
                                <p class="text-center text-gray-500">Select a user to view earnings</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCzCHZhz-1-enmDkuuvlfXkMD_-2gsHirM",
            authDomain: "rewardbee-140fe.firebaseapp.com",
            projectId: "rewardbee-140fe",
            storageBucket: "rewardbee-140fe.firebasestorage.app",
            messagingSenderId: "247840776508",
            appId: "1:247840776508:web:1e15bd4c78c96df156fe39"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make available globally
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.firebaseFunctions = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            doc,
            setDoc,
            addDoc,
            getDoc,
            getDocs,
            updateDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            serverTimestamp,
            ref,
            uploadBytes,
            getDownloadURL
        };

        console.log("Firebase ready");

        // Auth State
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'admin@ram.com') {
                // Hide admin buttons, show logout
                document.getElementById('desktopAdminBtn')?.classList.add('hidden');
                document.getElementById('mobileAdminBtn')?.classList.add('hidden');
                document.getElementById('desktopLogoutBtn')?.classList.remove('hidden');
                document.getElementById('mobileLogoutBtn')?.classList.remove('hidden');
                
                if (!document.getElementById('adminSection').classList.contains('hidden')) {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    loadAdminData();
                    // Load users dropdown when admin dashboard is shown
                    loadUsersDropdown();
                }
            } else {
                // Show admin buttons, hide logout
                document.getElementById('desktopAdminBtn')?.classList.remove('hidden');
                document.getElementById('mobileAdminBtn')?.classList.remove('hidden');
                document.getElementById('desktopLogoutBtn')?.classList.add('hidden');
                document.getElementById('mobileLogoutBtn')?.classList.add('hidden');
                
                document.getElementById('adminLogin').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });
    </script>

    <!-- Main Script -->
    <script>
        // State
        let currentUser = null;
        let currentMethod = 'upi';
        let usersListener = null;
        let withdrawalsListener = null;
        let earningsListener = null;
        let recentPayoutsListener = null;
        let usersDropdownListener = null;

        // Mobile Navigation
        function openMobileNav() {
            document.getElementById('mobileNav').classList.add('open');
            document.getElementById('mobileNavOverlay').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileNav() {
            document.getElementById('mobileNav').classList.remove('open');
            document.getElementById('mobileNavOverlay').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Helper Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showToast(title, msg, icon) {
            Swal.fire({ 
                title, 
                text: msg, 
                icon, 
                timer: 2000, 
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }
        
        function generateId() {
            return 'RET' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function maskName(name) {
            if (!name) return '';
            if (name.length <= 2) return name[0] + '***';
            return name.substring(0, 2) + '***';
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch {
                return 'N/A';
            }
        }
        
        function formatDateForInput(date) {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }

        // Navigation
        function showSection(section) {
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById(section + 'Section').classList.remove('hidden');
            closeMobileNav();
            
            if (section === 'home') {
                document.getElementById('userLogoutBtn').classList.add('hidden');
                loadRecentPayouts();
            } else if (section === 'dashboard') {
                document.getElementById('userLogoutBtn').classList.remove('hidden');
            } else {
                document.getElementById('userLogoutBtn').classList.add('hidden');
            }
        }

        // User Logout
        function userLogout() {
            currentUser = null;
            if (earningsListener) earningsListener();
            document.getElementById('userIdInput').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('userId').value = '';
            document.getElementById('userLogoutBtn').classList.add('hidden');
            showSection('home');
            showToast('Success', 'Logged out from dashboard', 'success');
        }

        // Registration
        function showRegisterModal() {
            document.getElementById('registerModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function hideRegisterModal() {
            document.getElementById('registerModal').classList.add('hidden');
            document.body.style.overflow = '';
            document.getElementById('regName').value = '';
        }
        
        function goHome() {
            document.getElementById('successModal').classList.add('hidden');
            document.body.style.overflow = '';
            showSection('home');
        }
        
        function copySuccessLink() {
            const link = document.getElementById('successLink').textContent;
            navigator.clipboard.writeText(link);
            showToast('Copied!', 'Link copied', 'success');
        }
        
        function copyMonetagLink() {
            const link = document.getElementById('monetagLink').href;
            navigator.clipboard.writeText(link);
            showToast('Copied!', 'Monetag link copied', 'success');
        }

        async function registerUser() {
            const name = document.getElementById('regName').value.trim();
            if (!name) {
                showToast('Error', 'Enter your name', 'error');
                return;
            }

            showLoading();
            try {
                const userId = generateId();
                const referralLink = window.location.origin + '/?ref=' + userId;
                
                await window.firebaseFunctions.setDoc(
                    window.firebaseFunctions.doc(db, 'users', userId),
                    {
                        name,
                        userId,
                        referralLink,
                        status: 'pending',
                        monetagLink: '',
                        isFirstWithdrawal: true,
                        createdAt: window.firebaseFunctions.serverTimestamp()
                    }
                );

                hideRegisterModal();
                document.getElementById('successUserId').textContent = userId;
                document.getElementById('successLink').textContent = referralLink;
                document.getElementById('successModal').classList.remove('hidden');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Recent Payouts
        function loadRecentPayouts() {
            try {
                const q = window.firebaseFunctions.query(
                    window.firebaseFunctions.collection(db, 'withdrawals'),
                    window.firebaseFunctions.where('status', '==', 'approved'),
                    window.firebaseFunctions.orderBy('date', 'desc'),
                    window.firebaseFunctions.limit(10)
                );

                if (recentPayoutsListener) recentPayoutsListener();
                
                recentPayoutsListener = window.firebaseFunctions.onSnapshot(q, (snap) => {
                    const grid = document.getElementById('recentPayoutsGrid');
                    
                    if (snap.empty) {
                        grid.innerHTML = '<p class="text-center text-gray-500 col-span-3 py-8">No payouts yet</p>';
                        return;
                    }

                    let html = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        html += `
                            <div class="card p-4 payout-card animate__animated animate__fadeInUp">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-rupee-sign text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-bold text-lg">â‚¹${d.amount}</p>
                                        <p class="text-sm text-gray-600">
                                            Sent to ${maskName(d.userName)} via ${d.method}
                                        </p>
                                        <p class="text-xs text-gray-400">${formatDate(d.date)}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    grid.innerHTML = html;
                });
            } catch (err) {
                console.error(err);
            }
        }

        // Dashboard
        async function loadDashboard() {
            const uid = document.getElementById('userId').value.trim();
            if (!uid) {
                showToast('Error', 'Enter User ID', 'error');
                return;
            }

            showLoading();
            try {
                const docRef = window.firebaseFunctions.doc(db, 'users', uid);
                const docSnap = await window.firebaseFunctions.getDoc(docRef);
                
                if (!docSnap.exists()) {
                    showToast('Error', 'User not found', 'error');
                    hideLoading();
                    return;
                }

                const data = docSnap.data();
                currentUser = { id: docSnap.id, ...data };

                // Update basic info
                document.getElementById('dashName').textContent = data.name;
                document.getElementById('dashUserId').textContent = data.userId;
                document.getElementById('dashReferral').textContent = data.referralLink;
                
                const statusEl = document.getElementById('dashStatus');
                statusEl.textContent = data.status;
                statusEl.className = 'status-badge status-' + data.status;

                // Show Monetag link only if approved
                if (data.status === 'approved' && data.monetagLink) {
                    document.getElementById('monetagContainer').classList.remove('hidden');
                    document.getElementById('monetagLink').textContent = data.monetagLink;
                    document.getElementById('monetagLink').href = data.monetagLink;
                } else {
                    document.getElementById('monetagContainer').classList.add('hidden');
                }

                // Load earnings and calculate totals
                loadUserEarnings(uid);

                document.getElementById('userIdInput').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('userLogoutBtn').classList.remove('hidden');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function loadUserEarnings(uid) {
            if (earningsListener) earningsListener();
            
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'earnings'),
                window.firebaseFunctions.where('userId', '==', uid),
                window.firebaseFunctions.orderBy('date', 'desc')
            );

            earningsListener = window.firebaseFunctions.onSnapshot(q, async (snap) => {
                let totalViews = 0;
                let totalEarnings = 0;
                let tableHtml = '';

                // Calculate totals from earnings
                snap.forEach(doc => {
                    const e = doc.data();
                    totalViews += e.views || 0;
                    totalEarnings += e.earnings || 0;
                    
                    tableHtml += `
                        <tr>
                            <td>${e.date || formatDate(e.createdAt)}</td>
                            <td>${e.views || 0}</td>
                            <td>â‚¹${e.earnings || 0}</td>
                        </tr>
                    `;
                });

                // Get approved withdrawals total
                const withdrawalsQuery = window.firebaseFunctions.query(
                    window.firebaseFunctions.collection(db, 'withdrawals'),
                    window.firebaseFunctions.where('userId', '==', uid),
                    window.firebaseFunctions.where('status', '==', 'approved')
                );
                
                const withdrawalsSnap = await window.firebaseFunctions.getDocs(withdrawalsQuery);
                let totalWithdrawn = 0;
                withdrawalsSnap.forEach(doc => {
                    totalWithdrawn += doc.data().amount || 0;
                });

                // Calculate available balance
                const availableBalance = totalEarnings - totalWithdrawn;

                // Update UI
                document.getElementById('totalViews').textContent = totalViews;
                document.getElementById('totalEarnings').textContent = 'â‚¹' + totalEarnings;
                document.getElementById('availableBalance').textContent = 'â‚¹' + availableBalance;
                document.getElementById('balance').textContent = 'â‚¹' + availableBalance;

                // Update earnings table
                document.getElementById('earningsTableBody').innerHTML = tableHtml || '<tr><td colspan="3" class="text-center py-4">No earnings yet</td></tr>';

                // Update min amount and withdraw button
                const minAmt = currentUser.isFirstWithdrawal ? 50 : 200;
                document.getElementById('minAmount').textContent = `Min: â‚¹${minAmt}`;
                
                const btn = document.getElementById('withdrawBtn');
                if (availableBalance < minAmt || currentUser.status !== 'approved') {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            });

            // Load withdrawal history
            loadWithdrawalHistory(uid);
        }

        function loadWithdrawalHistory(uid) {
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'withdrawals'),
                window.firebaseFunctions.where('userId', '==', uid),
                window.firebaseFunctions.orderBy('date', 'desc')
            );

            window.firebaseFunctions.onSnapshot(q, (snap) => {
                const list = document.getElementById('historyList');
                if (snap.empty) {
                    list.innerHTML = '<p class="text-center text-gray-500 py-4">No history yet</p>';
                    return;
                }

                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold">â‚¹${d.amount}</p>
                                    <p class="text-xs text-gray-500">${d.method} â€¢ ${d.upiId}</p>
                                    <p class="text-xs text-gray-400">${formatDate(d.date)}</p>
                                </div>
                                <span class="status-badge status-${d.status}">${d.status}</span>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            });
        }

        function setMethod(method) {
            currentMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`method${method.charAt(0).toUpperCase() + method.slice(1)}`).classList.add('active');
        }

        async function submitWithdrawal() {
            if (!currentUser) return;
            
            const amt = parseInt(document.getElementById('withdrawAmount').value);
            const upi = document.getElementById('upiId').value.trim();
            const min = currentUser.isFirstWithdrawal ? 50 : 200;

            if (!amt || amt < min) {
                showToast('Error', `Minimum â‚¹${min}`, 'error');
                return;
            }

            // Check against available balance
            const balanceText = document.getElementById('availableBalance').textContent;
            const availableBalance = parseInt(balanceText.replace('â‚¹', ''));
            
            if (amt > availableBalance) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }

            if (!upi) {
                showToast('Error', 'Enter UPI ID', 'error');
                return;
            }

            // Simple UPI validation
            const upiRegex = /^[a-zA-Z0-9.\-_]{2,}@[a-zA-Z]{2,}$/;
            if (!upiRegex.test(upi)) {
                showToast('Error', 'Invalid UPI format', 'error');
                return;
            }

            showLoading();
            try {
                await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(db, 'withdrawals'),
                    {
                        userId: currentUser.userId,
                        userName: currentUser.name,
                        amount: amt,
                        method: currentMethod,
                        upiId: upi,
                        status: 'pending',
                        date: window.firebaseFunctions.serverTimestamp()
                    }
                );

                document.getElementById('withdrawAmount').value = '';
                document.getElementById('upiId').value = '';
                showToast('Success', 'Withdrawal request submitted!', 'success');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function copyDashLink() {
            navigator.clipboard.writeText(currentUser.referralLink);
            showToast('Copied!', 'Link copied', 'success');
        }

        // Admin
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPassword').value;

            if (!email || !pass) {
                showToast('Error', 'Please enter email and password', 'error');
                return;
            }

            showLoading();
            try {
                await window.firebaseFunctions.signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            await window.firebaseFunctions.signOut(auth);
            if (usersListener) usersListener();
            if (withdrawalsListener) withdrawalsListener();
            if (earningsListener) earningsListener();
            if (recentPayoutsListener) recentPayoutsListener();
            if (usersDropdownListener) usersDropdownListener();
            showSection('home');
        }

        function switchTab(tab) {
            // Hide all tabs
            document.getElementById('usersTab').classList.add('hidden');
            document.getElementById('pendingTab').classList.add('hidden');
            document.getElementById('approvedTab').classList.add('hidden');
            document.getElementById('withdrawalsTab').classList.add('hidden');
            document.getElementById('earningsTab').classList.add('hidden');
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            document.getElementById(tab + 'TabBtn').classList.add('active');
            
            // Set default date if earnings tab
            if (tab === 'earnings') {
                document.getElementById('earningsDate').value = formatDateForInput();
            }
        }

        // NEW FUNCTION: Load users dropdown with real-time updates
        function loadUsersDropdown() {
            const usersRef = window.firebaseFunctions.collection(db, 'users');
            
            if (usersDropdownListener) {
                usersDropdownListener();
            }

            usersDropdownListener = window.firebaseFunctions.onSnapshot(usersRef, (snapshot) => {
                const select = document.getElementById('earningsUserSelect');
                
                // Start with default option
                let options = '<option value="">Choose a user...</option>';
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use document ID as userId (since we store with userId as doc ID)
                    options += `<option value="${doc.id}">${data.name} (${doc.id})</option>`;
                });
                
                select.innerHTML = options;
                
                // If no users found
                if (snapshot.empty) {
                    select.innerHTML = '<option value="">No users found</option>';
                }
            }, (error) => {
                console.error('Error loading users dropdown:', error);
                document.getElementById('earningsUserSelect').innerHTML = '<option value="">Error loading users</option>';
            });
        }

        async function addDailyEarnings() {
            const userId = document.getElementById('earningsUserSelect').value;
            const date = document.getElementById('earningsDate').value;
            const views = parseInt(document.getElementById('earningsViews').value);
            const earnings = parseInt(document.getElementById('earningsAmount').value);

            if (!userId) {
                showToast('Error', 'Select a user', 'error');
                return;
            }
            if (!date) {
                showToast('Error', 'Select date', 'error');
                return;
            }
            if (!views || views < 0) {
                showToast('Error', 'Enter valid views', 'error');
                return;
            }
            if (!earnings || earnings < 0) {
                showToast('Error', 'Enter valid earnings', 'error');
                return;
            }

            showLoading();
            try {
                await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(db, 'earnings'),
                    {
                        userId,
                        date,
                        views,
                        earnings,
                        createdAt: window.firebaseFunctions.serverTimestamp()
                    }
                );

                // Clear form
                document.getElementById('earningsViews').value = '';
                document.getElementById('earningsAmount').value = '';
                
                showToast('Success', 'Earnings added successfully', 'success');
                
                // Show recent earnings for this user
                showUserRecentEarnings(userId);
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function showUserRecentEarnings(userId) {
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'earnings'),
                window.firebaseFunctions.where('userId', '==', userId),
                window.firebaseFunctions.orderBy('date', 'desc'),
                window.firebaseFunctions.limit(5)
            );
            
            const snap = await window.firebaseFunctions.getDocs(q);
            let html = '';
            
            snap.forEach(doc => {
                const e = doc.data();
                html += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between">
                            <span class="font-medium">${e.date}</span>
                            <span>${e.views} views</span>
                            <span class="text-green-600 font-bold">â‚¹${e.earnings}</span>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('selectedUserEarnings').innerHTML = html || '<p class="text-center text-gray-500">No earnings for this user</p>';
        }

        // Add event listener for user select change
        document.addEventListener('DOMContentLoaded', function() {
            // Set up change listener for user select
            const userSelect = document.getElementById('earningsUserSelect');
            if (userSelect) {
                userSelect.addEventListener('change', function(e) {
                    if (e.target.value) {
                        showUserRecentEarnings(e.target.value);
                    } else {
                        document.getElementById('selectedUserEarnings').innerHTML = '<p class="text-center text-gray-500">Select a user to view earnings</p>';
                    }
                });
            }
        });

        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied!', 'Text copied', 'success');
        }

        async function updateUserStatus(uid, status) {
            await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'users', uid), { status });
            showToast('Success', `User ${status}`, 'success');
        }

        function editUser(uid, link) {
            Swal.fire({
                title: 'Edit User',
                html: `
                    <div class="space-y-3">
                        <input id="monetag" class="w-full p-3 border rounded-lg text-sm" value="${link}" placeholder="Monetag Link">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Update',
                confirmButtonColor: '#8b5cf6',
                preConfirm: () => ({
                    monetagLink: document.getElementById('monetag').value
                })
            }).then(async (r) => {
                if (r.isConfirmed) {
                    await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'users', uid), r.value);
                    showToast('Success', 'User updated', 'success');
                }
            });
        }

        async function approveWithdrawal(wid, uid) {
            try {
                await window.firebaseFunctions.updateDoc(
                    window.firebaseFunctions.doc(db, 'withdrawals', wid),
                    { status: 'approved' }
                );

                // Update user's first withdrawal status
                const userDoc = await window.firebaseFunctions.getDoc(
                    window.firebaseFunctions.doc(db, 'users', uid)
                );
                
                if (userDoc.exists() && userDoc.data().isFirstWithdrawal) {
                    await window.firebaseFunctions.updateDoc(
                        window.firebaseFunctions.doc(db, 'users', uid),
                        { isFirstWithdrawal: false }
                    );
                }

                showToast('Success', 'Withdrawal approved', 'success');
            } catch (err) {
                showToast('Error', err.message, 'error');
            }
        }

        async function rejectWithdrawal(wid) {
            await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'withdrawals', wid), { status: 'rejected' });
            showToast('Success', 'Withdrawal rejected', 'success');
        }

        async function loadAdminData() {
            // Load users
            const usersQuery = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'users'),
                window.firebaseFunctions.orderBy('createdAt', 'desc')
            );

            if (usersListener) usersListener();
            usersListener = window.firebaseFunctions.onSnapshot(usersQuery, async (snap) => {
                let allUsersHtml = '';
                let pendingHtml = '';
                let approvedHtml = '';
                let total = 0;
                let pending = 0;
                let approved = 0;
                
                for (const doc of snap.docs) {
                    const u = doc.data();
                    total++;
                    
                    // Get user totals
                    const totals = await calculateUserTotals(u.userId);
                    
                    if (u.status === 'pending') {
                        pending++;
                        pendingHtml += `
                            <tr>
                                <td class="font-medium">${u.name}</td>
                                <td><span class="font-mono text-sm">${u.userId}</span></td>
                                <td>${formatDate(u.createdAt)}</td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="updateUserStatus('${u.userId}', 'approved')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button onclick="updateUserStatus('${u.userId}', 'rejected')" class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else if (u.status === 'approved') {
                        approved++;
                        approvedHtml += `
                            <tr>
                                <td class="font-medium">${u.name}</td>
                                <td><span class="font-mono text-sm">${u.userId}</span></td>
                                <td>${totals.views}</td>
                                <td>â‚¹${totals.earnings}</td>
                                <td>
                                    ${u.monetagLink ? `
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-blue-600 truncate max-w-[150px]">${u.monetagLink}</span>
                                            <button onclick="copyText('${u.monetagLink}')" class="copy-btn p-1">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    ` : '<span class="text-gray-400">Not set</span>'}
                                </td>
                                <td>
                                    <button onclick="editUser('${u.userId}', '${u.monetagLink || ''}')" class="px-3 py-1 bg-purple-600 text-white rounded-lg text-sm">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    // All users row with calculations
                    allUsersHtml += `
                        <tr>
                            <td class="font-medium">${u.name}</td>
                            <td><span class="font-mono text-sm">${u.userId}</span></td>
                            <td><span class="status-badge status-${u.status}">${u.status}</span></td>
                            <td>${totals.views}</td>
                            <td>â‚¹${totals.earnings}</td>
                            <td>â‚¹${totals.withdrawn}</td>
                            <td>â‚¹${totals.balance}</td>
                            <td>
                                <div class="flex gap-2">
                                    <button onclick="editUser('${u.userId}', '${u.monetagLink || ''}')" class="text-purple-600 hover:text-purple-700">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                document.getElementById('allUsersList').innerHTML = allUsersHtml || '<tr><td colspan="8" class="text-center py-4">No users found</td></tr>';
                document.getElementById('pendingUsersList').innerHTML = pendingHtml || '<tr><td colspan="4" class="text-center py-4">No pending users</td></tr>';
                document.getElementById('approvedUsersList').innerHTML = approvedHtml || '<tr><td colspan="6" class="text-center py-4">No approved users</td></tr>';
                
                document.getElementById('adminTotalUsers').textContent = total;
                document.getElementById('adminPendingUsers').textContent = pending;
                document.getElementById('adminApprovedUsers').textContent = approved;
            });

            // Load withdrawals
            const withdrawalsQuery = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'withdrawals'),
                window.firebaseFunctions.orderBy('date', 'desc')
            );

            if (withdrawalsListener) withdrawalsListener();
            withdrawalsListener = window.firebaseFunctions.onSnapshot(withdrawalsQuery, (snap) => {
                let html = '';
                let total = 0;
                let pending = 0;
                
                snap.forEach(doc => {
                    const w = doc.data();
                    total++;
                    if (w.status === 'pending') pending++;
                    
                    html += `
                        <tr>
                            <td class="font-medium">${w.userName}</td>
                            <td class="font-bold">â‚¹${w.amount}</td>
                            <td>${w.method}</td>
                            <td><span class="font-mono text-sm">${w.upiId}</span></td>
                            <td>${formatDate(w.date)}</td>
                            <td><span class="status-badge status-${w.status}">${w.status}</span></td>
                            <td>
                                <div class="flex gap-2">
                                    ${w.status === 'pending' ? `
                                        <button onclick="approveWithdrawal('${doc.id}', '${w.userId}')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="rejectWithdrawal('${doc.id}')" class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('withdrawalsList').innerHTML = html || '<tr><td colspan="7" class="text-center py-4">No withdrawals found</td></tr>';
                document.getElementById('adminTotalWithdrawals').textContent = total;
                document.getElementById('adminPendingWithdrawals').textContent = pending;
            });
        }

        async function calculateUserTotals(userId) {
            let views = 0;
            let earnings = 0;
            let withdrawn = 0;

            // Get earnings
            const earningsQuery = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'earnings'),
                window.firebaseFunctions.where('userId', '==', userId)
            );
            const earningsSnap = await window.firebaseFunctions.getDocs(earningsQuery);
            earningsSnap.forEach(doc => {
                const e = doc.data();
                views += e.views || 0;
                earnings += e.earnings || 0;
            });

            // Get approved withdrawals
            const withdrawalsQuery = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'withdrawals'),
                window.firebaseFunctions.where('userId', '==', userId),
                window.firebaseFunctions.where('status', '==', 'approved')
            );
            const withdrawalsSnap = await window.firebaseFunctions.getDocs(withdrawalsQuery);
            withdrawalsSnap.forEach(doc => {
                withdrawn += doc.data().amount || 0;
            });

            return {
                views,
                earnings,
                withdrawn,
                balance: earnings - withdrawn
            };
        }

        // Expose functions
        window.showSection = showSection;
        window.openMobileNav = openMobileNav;
        window.closeMobileNav = closeMobileNav;
        window.showRegisterModal = showRegisterModal;
        window.hideRegisterModal = hideRegisterModal;
        window.registerUser = registerUser;
        window.goHome = goHome;
        window.copySuccessLink = copySuccessLink;
        window.copyMonetagLink = copyMonetagLink;
        window.loadDashboard = loadDashboard;
        window.setMethod = setMethod;
        window.submitWithdrawal = submitWithdrawal;
        window.copyDashLink = copyDashLink;
        window.adminLogin = adminLogin;
        window.logout = logout;
        window.userLogout = userLogout;
        window.switchTab = switchTab;
        window.updateUserStatus = updateUserStatus;
        window.editUser = editUser;
        window.approveWithdrawal = approveWithdrawal;
        window.rejectWithdrawal = rejectWithdrawal;
        window.copyText = copyText;
        window.addDailyEarnings = addDailyEarnings;
        window.loadUsersDropdown = loadUsersDropdown;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRecentPayouts();
            
            // Set up change listener for user select
            const userSelect = document.getElementById('earningsUserSelect');
            if (userSelect) {
                userSelect.addEventListener('change', function(e) {
                    if (e.target.value) {
                        showUserRecentEarnings(e.target.value);
                    } else {
                        document.getElementById('selectedUserEarnings').innerHTML = '<p class="text-center text-gray-500">Select a user to view earnings</p>';
                    }
                });
            }
            
            const ref = new URLSearchParams(location.search).get('ref');
            if (ref) {
                document.getElementById('userId').value = ref;
                setTimeout(() => {
                    showSection('dashboard');
                    loadDashboard();
                }, 500);
            }
        });
    </script>
</body>
</html>
